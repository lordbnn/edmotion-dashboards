const GOOGLE_SCRIPT_URL='https://script.google.com/macros/s/AKfycbzdgbiLLP7YabBURgP4tPcS_a8lb8A5Xn94XlYN7KepfXB1knyEbWpCh7BmKKAW2I841A/exec';

let currentStep=1;
const totalSteps=6;

document.addEventListener('DOMContentLoaded',()=>{
    setupEvents();
    updateProgress();
    setupInputStyles();
});

function setupEvents(){
    const form=document.getElementById('projectForm');
    document.getElementById('nextBtn').addEventListener('click',nextStep);
    document.getElementById('prevBtn').addEventListener('click',prevStep);

    form.addEventListener('submit',e=>{
        e.preventDefault();
        submitForm();
    });

    document.getElementById('startDate').addEventListener('change',e=>{
        const group=document.getElementById('specificDateGroup');
        const specific=document.getElementById('specificStartDate');
        if(e.target.value==='specific'){
            group.style.display='block';
            specific.required=true;
        } else {
            group.style.display='none';
            specific.required=false;
        }
    });
}

function setupInputStyles(){
    document.querySelectorAll('input[type="radio"]').forEach(r=>{
        r.addEventListener('change',()=>{
            document.querySelectorAll(`input[name="${r.name}"]`).forEach(x=>{
                x.closest('.radio-item').classList.remove('checked');
            });
            r.closest('.radio-item').classList.add('checked');
        });
    });

    document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(c=>{
        c.addEventListener('change',()=>{
            c.closest('.checkbox-item').classList.toggle('checked',c.checked);
        });
    });
}

function nextStep(){
    if(!validateStep()) return;
    if(currentStep<totalSteps){
        if(currentStep===5) populateReview();
        currentStep++;
        showStep();
    }
}

function prevStep(){
    if(currentStep>1){
        currentStep--;
        showStep();
    }
}

function showStep(){
    document.querySelectorAll('.form-step').forEach(s=>s.classList.remove('active'));
    document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');

    document.getElementById('prevBtn').style.display=currentStep===1?'none':'block';
    document.getElementById('nextBtn').style.display=currentStep===totalSteps?'none':'block';
    document.getElementById('submitBtn').style.display=currentStep===totalSteps?'block':'none';

    updateProgress();
}

function updateProgress(){
    document.querySelectorAll('.progress-step').forEach((s,i)=>{
        const num=i+1;
        s.classList.toggle('completed',num<currentStep);
        s.classList.toggle('active',num===currentStep);
    });
}

function validateStep(){
    const step=document.querySelector(`.form-step[data-step="${currentStep}"]`);
    const fields=step.querySelectorAll('[required]');
    let valid=true;

    fields.forEach(f=>{
        const isRadio=f.type==='radio';
        const radioValid=isRadio && document.querySelector(`input[name="${f.name}"]:checked`);
        if((!f.value && !isRadio) || (isRadio && !radioValid)){
            valid=false;
            f.classList.add('field-error');
            const err=f.parentElement.querySelector('.error-text');
            if(err) err.style.display='block';
        } else {
            f.classList.remove('field-error');
            const err=f.parentElement.querySelector('.error-text');
            if(err) err.style.display='none';
        }
    });

    return valid;
}

function populateReview(){
    const data=new FormData(document.getElementById('projectForm'));
    const container=document.getElementById('reviewContent');

    const sections=[
        {title:'Contact',keys:['contactName','companyName','email','phone','commMethod']},
        {title:'Project',keys:['projectTitle','projectCategory','projectDescription']},
        {title:'Timeline',keys:['startDate','deadline','budgetAmount','currency','paymentTerms']}
    ];

    container.innerHTML=sections.map(sec=>{
        return `
        <div class="review-section">
            <h4>${sec.title}</h4>
            ${sec.keys.map(k=>{
                const v=data.get(k)||'Not provided';
                return `
                <div class="review-item">
                    <span class="review-label">${k.replace(/([A-Z])/g,' $1')}:</span>
                    <span class="review-value">${v}</span>
                </div>`;
            }).join('')}
        </div>`;
    }).join('');
}

async function submitForm(){
    const btn=document.getElementById('submitBtn');
    const spinner=document.getElementById('spinner');
    const success=document.getElementById('successMessage');
    const error=document.getElementById('errorMessage');
    const body=document.querySelector('.wizard-body');
    const footer=document.querySelector('.wizard-footer');

    if(!validateStep()) return;

    btn.disabled=true;
    spinner.style.display='inline-block';
    btn.querySelector('span').textContent='Submitting...';
    success.style.display='none';
    error.style.display='none';

    const formData=new FormData(document.getElementById('projectForm'));
    const payload=Object.fromEntries(formData.entries());
    payload.timestamp=new Date().toISOString();

    try{
        await fetch(GOOGLE_SCRIPT_URL,{
            method:'POST',
            mode:'no-cors',
            headers:{'Content-Type':'text/plain'},
            body:JSON.stringify(payload)
        });

        body.style.display='none';
        footer.style.display='none';
        success.style.display='block';

        setTimeout(()=>{
            document.getElementById('projectForm').reset();
            currentStep=1;
            showStep();
            body.style.display='block';
            footer.style.display='flex';
            success.style.display='none';
        },5000);

    }catch(e){
        error.style.display='block';
    } finally{
        btn.disabled=false;
        spinner.style.display='none';
        btn.querySelector('span').textContent='Submit Project';
    }
}
